name: Image
#触发器设置
on:
  push: # master分支有push时触发此workflow
    branches: [ "main" ]
  pull_request: 
    branches: [ "main" ]
    
env:
  tag: "kingbase:v8r3"
  ghcr: "ghcr.io/eazonziu"
  dockerhub: "haloking"
  workplace: "https://github.com/EazonZiu/kingbase-v8-r3-workflow.git"

#项目任务，任务之间可以并行调度
jobs:
      
  ghcr:
    #needs: [build] #需要等待任务完成
    #选择云端运行的环境
    runs-on: ubuntu-latest # job运行的基础环境
  
    steps: # 一个job由一个或多个step组成
          
      - name: Log in to ghcr Hub
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Push to ghcr Hub
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: ${{ env.ghcr }}/${{ env.tag }}
          context: ${{ workplace }} #構建dockerfile的上下文位置
          
  dockerhub:
    #needs: [build] #需要等待任务完成
    #选择云端运行的环境
    runs-on: ubuntu-latest # job运行的基础环境
  
    steps: # 一个job由一个或多个step组成
          
      - name: Log in to Docker Hub
        uses: docker/login-action@v2  # 三方的action操作， 执行docker login
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}  # 配置dockerhub的认证，在Github项目主页 【Settings】 -> 【Secrets】 添加对应变量
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Push to Docker Hub
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: ${{ env.dockerhub }}/${{ env.tag }}
          context: ${{ workplace }}
